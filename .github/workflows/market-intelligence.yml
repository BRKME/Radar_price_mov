name: Crypto Market Intelligence

on:
  schedule:
    - cron: '0,15,30,45 * * * *'  # –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
  workflow_dispatch:
  push:
    branches:
      - main

# –£–±–µ—Ä–∏—Ç–µ concurrency –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
# concurrency:
#   group: market-intelligence
#   cancel-in-progress: false

jobs:
  intelligence:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      - name: Log schedule info
        run: |
          echo "üïí –ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é: ${{ github.event_name == 'schedule' }}"
          echo "üìÖ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è UTC: $(date -u)"
          echo "üè∑Ô∏è Event: ${{ github.event_name }}"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è git –æ–ø–µ—Ä–∞—Ü–∏–π
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run Intelligence Engine
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞..."
          python market_intelligence.py
          echo "‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω"
      
      - name: Commit and push changes
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ state.json..."
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git status --porcelain | grep -q 'state.json'; then
            echo "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ–º–º–∏—Ç–∏–º..."
            git add state.json
            git commit -m "ü§ñ Auto-update: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git pull --rebase origin main
            git push origin main
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã"
          else
            echo "‚è≠Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–∏—Ç"
          fi
      
      - name: Notification on failure
        if: failure()
        run: |
          echo "‚ùå Workflow –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"
