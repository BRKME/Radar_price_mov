name: Crypto Market Intelligence

# Ð¢Ð Ð˜Ð“Ð“Ð•Ð Ð« - ÐžÐ§Ð•ÐÐ¬ Ð’ÐÐ–ÐÐž ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐžÐ• Ð¤ÐžÐ ÐœÐÐ¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•
on:
  # 1. ÐŸÐž Ð ÐÐ¡ÐŸÐ˜Ð¡ÐÐÐ˜Ð® (ÐºÐ°Ð¶Ð´Ñ‹Ðµ 15 Ð¼Ð¸Ð½ÑƒÑ‚)
  schedule:
    - cron: '*/30 * * * *'
  
  # 2. Ð Ð£Ð§ÐÐžÐ™ Ð—ÐÐŸÐ£Ð¡Ðš
  workflow_dispatch:
  
  # 3. ÐŸÐ Ð˜ ÐŸÐ£Ð¨Ð• Ð’ ÐœÐÐ˜Ð
  push:
    branches:
      - main

# Ð£Ð‘Ð•Ð Ð˜Ð¢Ð• concurrency ÐÐ Ð’Ð Ð•ÐœÐ¯ Ð¢Ð•Ð¡Ð¢Ð
# concurrency:
#   group: market-intelligence
#   cancel-in-progress: false

jobs:
  intelligence:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # Ð¨Ð°Ð³ 1: ÐžÐ¢Ð›ÐÐ”ÐžÐ§ÐÐÐ¯ Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯ Ðž Ð¢Ð Ð˜Ð“Ð“Ð•Ð Ð•
      - name: Show trigger information
        run: |
          echo "=========================================="
          echo "ðŸŽ¯ WORKFLOW TRIGGERED BY: ${{ github.event_name }}"
          echo "ðŸ• CURRENT UTC TIME: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸ“Š GITHUB EVENT:"
          echo "${{ toJson(github.event) }}" | jq . 2>/dev/null || echo "No JSON data"
          echo "=========================================="
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð² Ñ„Ð°Ð¹Ð»
          echo "Last run: $(date -u)" > last_run.txt
          echo "Trigger: ${{ github.event_name }}" >> last_run.txt
          echo "Repository: ${{ github.repository }}" >> last_run.txt
      
      # Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¸Ð¿Ð° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
      - name: Check event type
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "âœ…âœ…âœ… Ð—ÐÐŸÐ£Ð©Ð•ÐÐž ÐŸÐž Ð ÐÐ¡ÐŸÐ˜Ð¡ÐÐÐ˜Ð® âœ…âœ…âœ…"
            echo "Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· 15 Ð¼Ð¸Ð½ÑƒÑ‚"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ðŸ‘† Ð Ð£Ð§ÐÐžÐ™ Ð—ÐÐŸÐ£Ð¡Ðš"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "ðŸ“¤ Ð—ÐÐŸÐ£Ð©Ð•ÐÐž Ð§Ð•Ð Ð•Ð— PUSH"
          else
            echo "â“ ÐÐ•Ð˜Ð—Ð’Ð•Ð¡Ð¢ÐÐ«Ð™ Ð¢Ð Ð˜Ð“Ð“Ð•Ð : ${{ github.event_name }}"
          fi
      
      # Ð¨Ð°Ð³ 3: Checkout ÐºÐ¾Ð´Ð°
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Ð¨Ð°Ð³ 4: Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # Ð¨Ð°Ð³ 5: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      - name: Install dependencies
        run: |
          echo "Installing Python dependencies..."
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      # Ð¨Ð°Ð³ 6: Ð—Ð°Ð¿ÑƒÑÐº ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°
      - name: Run market intelligence
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python market_intelligence.py
      
      # Ð¨Ð°Ð³ 7: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
      - name: Save run info
        run: |
          echo "Workflow completed at: $(date -u)" >> workflow_log.txt
          echo "Status: SUCCESS" >> workflow_log.txt
          cat workflow_log.txt
